import{aG as e,o as a,ap as t,Z as l,aZ as o,bB as r,r as s,c as n,d as i,aC as u,b1 as d,W as c,aI as m,cp as p,g as f,f as g,m as y,w as b,D as v,$ as h,ag as _,ah as w,ai as k,ac as V,e as j,h as x,i as C,b7 as U,G as I,S,V as A,eA as E,by as M}from"./index.Dv9sjPYC.js";import{v as R}from"./loading.S8LTmobk.js";import{E as T}from"./drawer.BVgiL_Wv.js";import{E as z}from"./switch.CjnXXg_L.js";import{_ as $}from"./index.vue_vue_type_script_setup_true_lang.DBPr1bj8.js";import{E as B,a as N}from"./select.D46WCvpG.js";import"./scrollbar.DQblMs23.js";import"./popper.m2lNosSJ.js";import"./tree.Dcl2NF7B.js";import"./checkbox.Cq-dvxYE.js";import"./text.PvK_Xx8y.js";import{E as q}from"./tree-select.BYKNxPD6.js";import{a as D,E as L}from"./col.BTxHlVsk.js";import{E as O}from"./card.UCV2TBx1.js";import{_ as P}from"./index.D-M2h4YD.js";import{a as F,E as Z}from"./table-column.D28nzGFS.js";/* empty css                */import{_ as Y}from"./DictLabel.vue_vue_type_script_setup_true_lang.CielTJsp.js";import{a as G,E as H}from"./form-item.DgRMSZzs.js";import{E as J}from"./date-picker-panel.BOvuOK0w.js";import{D as K}from"./dept-api.bH3oIJyj.js";import{R as W}from"./role-api.CuRBb4fH.js";import{E as Q}from"./index.BqKoy5Fw.js";import{_ as X}from"./DeptTree.vue_vue_type_script_setup_true_lang.D-pQuyVd.js";import{_ as ee}from"./UserImport.vue_vue_type_script_setup_true_lang.BY0rMFaN.js";/* empty css                       */import"./radio-group.DKuTe-fa.js";import"./omit.B6E_lyF8.js";import"./_baseClone.Br4BWTY9.js";import"./strings.BtizHOxT.js";import"./toNumber.P9ps2NTq.js";import"./castArray.D1K_WIrw.js";import"./_baseIteratee.DbpbFJtj.js";import"./index.8lkWLndA.js";import"./index.C5bLMH_j.js";import"./pagination.CWkEuBr5.js";import"./debounce.CITkvERZ.js";import"./raf.B6j8aosc.js";import"./dayjs.min.nvYJnoDs.js";import"./index.BlULC2eY.js";import"./upload.BgURkZfm.js";import"./progress.B6GDuKkw.js";import"./link.CHuo07Uc.js";const ae={class:"app-container"},te={class:"search-container"},le={class:"data-table__toolbar"},oe={class:"data-table__toolbar--actions"},re={class:"data-table__toolbar--tools"},se={class:"dialog-footer"},ne=i({name:"SystemUser",inheritAttrs:!1,__name:"index",setup(i){const ne=u(),ie=d(),ue=s(),de=s(),ce=c({pageNum:1,pageSize:10}),me=s(),pe=s(0),fe=s(!1),ge=c({visible:!1,title:"新增用户"}),ye=c({status:1}),be=s(),ve=s(),he=s(!1),_e=n(()=>ne.device===m.DESKTOP?"600px":"90%"),we=c({username:[{required:!0,message:"用户名不能为空",trigger:"blur"}],nickname:[{required:!0,message:"用户昵称不能为空",trigger:"blur"}],deptId:[{required:!0,message:"所属部门不能为空",trigger:"blur"}],roleIds:[{required:!0,message:"用户角色不能为空",trigger:"blur"}],email:[{pattern:/\w[-\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+\.)+[A-Za-z]{2,14}/,message:"请输入正确的邮箱地址",trigger:"blur"}],mobile:[{pattern:/^1[3|4|5|6|7|8|9][0-9]\d{8}$/,message:"请输入正确的手机号码",trigger:"blur"}]});async function ke(){fe.value=!0;try{const e=await M.getPage(ce);me.value=e.list,pe.value=e.total}catch(e){o.error("获取用户列表失败")}finally{fe.value=!1}}const{selectedIds:Ve,hasSelection:je,handleSelectionChange:xe}=function(){const e=s([]),a=n(()=>e.value.length),t=n(()=>e.value.length>0);return{selectedIds:e,selectedCount:a,hasSelection:t,handleSelectionChange:function(a){e.value=a.map(e=>e.id)},clearSelection:function(){e.value=[]},isSelected:function(a){return e.value.includes(a)}}}();function Ce(){return ce.pageNum=1,ke()}function Ue(){ue.value.resetFields(),ce.deptId=void 0,ce.createTime=void 0,Ce()}async function Ie(e){ge.visible=!0;try{[ve.value,be.value]=await Promise.all([W.getOptions(),K.getOptions()])}catch(a){o.error("加载选项数据失败")}if(e){ge.title="修改用户";try{const a=await M.getFormData(e);Object.assign(ye,a)}catch(a){o.error("加载用户数据失败")}}else ge.title="新增用户"}function Se(){ge.visible=!1,de.value.resetFields(),de.value.clearValidate(),ye.id=void 0,ye.status=1}const Ae=E(async()=>{if(!(await de.value.validate().catch(()=>!1)))return;const e=ye.id;fe.value=!0;try{e?(await M.update(e,ye),o.success("修改用户成功")):(await M.create(ye),o.success("新增用户成功")),Se(),Ue()}catch(a){o.error(e?"修改用户失败":"新增用户失败")}finally{fe.value=!1}},1e3);function Ee(e){const a=e||Ve.value.join(",");if(!a)return void o.warning("请勾选删除项");const t=ie.userInfo?.userId;if(t){if(e?e===t:Ve.value.some(e=>String(e)===t))return void o.error("不能删除当前登录用户")}Q.confirm("确认删除选中的用户吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{fe.value=!0;try{await M.deleteByIds(a),o.success("删除成功"),Ue()}catch(e){o.error("删除失败")}finally{fe.value=!1}}).catch(()=>{})}function Me(){he.value=!0}async function Re(){try{const e=await M.export(ce),a=e.data,t=e.headers["content-disposition"],l=decodeURI(t.split(";")[1].split("=")[1]),r=new Blob([a],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8"}),s=window.URL.createObjectURL(r),n=document.createElement("a");n.href=s,n.download=l,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(s),o.success("导出成功")}catch(e){o.error("导出失败")}}return function(s={}){const n=e(),{actionHandlers:i={},onRefresh:u,onAutoSearch:d,currentRoute:c=n.path}=s;let m=!1;async function p(e){if(m)return;const a=e.functionCall??{name:e.functionName,arguments:e.arguments};if(!a?.name)return void o.warning("未识别的 AI 操作");const t=i[a.name];if(t)try{if("function"==typeof t)await t(a.arguments);else{const l=t;if(!1!==l.needConfirm){const e="function"==typeof l.confirmMessage?l.confirmMessage(a.arguments):l.confirmMessage||"确认执行此操作吗？";await Q.confirm(e,"AI 助手操作确认",{confirmButtonText:"确认执行",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0})}l.callBackendApi?await r.executeCommand({originalCommand:e.originalCommand||"",confirmMode:"manual",userConfirmed:!0,currentRoute:c,functionCall:{name:a.name,arguments:a.arguments}}):await l.execute(a.arguments);const s="function"==typeof l.successMessage?l.successMessage(a.arguments):l.successMessage||"操作执行成功";o.success(s)}u&&await u()}catch(l){if("cancel"===l)return void o.info("已取消操作");o.error(l.message||"操作执行失败")}else o.warning(`暂不支持操作: ${a.name}`)}function f(e){d?d(e):o.info(`AI 助手已为您自动搜索：${e}`)}async function g(){if(m)return;const e=n.query.keywords,a=n.query.autoSearch,t=n.query.aiAction;(e||a||t)&&l(async()=>{if(!m&&("true"===a&&e&&f(e),t))try{const e=JSON.parse(decodeURIComponent(t));await p(e)}catch(l){o.error("AI 操作参数解析失败")}})}a(()=>{g()}),t(()=>{m=!0})}({actionHandlers:{updateUserNickname:{needConfirm:!0,callBackendApi:!0,confirmMessage:e=>`AI 助手将执行以下操作：<br/>\n        <strong>修改用户：</strong> ${e.username}<br/>\n        <strong>新昵称：</strong> ${e.nickname}<br/><br/>\n        确认执行吗？`,successMessage:e=>`已将用户 ${e.username} 的昵称修改为 ${e.nickname}`,execute:async()=>{}},queryUser:{needConfirm:!1,successMessage:e=>`已搜索：${e.keywords}`,execute:async e=>{ce.keywords=e.keywords,await Ce()}}},onRefresh:ke,onAutoSearch:e=>{ce.keywords=e,setTimeout(()=>{Ce(),o.success(`AI 助手已为您自动搜索：${e}`)},300)}}),a(()=>{Ce()}),(e,a)=>{const t=D,l=h,r=H,s=N,n=B,i=J,u=w,d=G,c=Z,m=Y,E=U,K=F,W=P,ne=O,ie=L,Ve=q,Te=$,ze=z,$e=T,Be=p("hasPerm"),Ne=R;return g(),f("div",ae,[y(ie,{gutter:20},{default:b(()=>[y(t,{lg:4,xs:24,class:"mb-[12px]"},{default:b(()=>[y(X,{modelValue:ce.deptId,"onUpdate:modelValue":a[0]||(a[0]=e=>ce.deptId=e),onNodeClick:Ce},null,8,["modelValue"])]),_:1}),y(t,{lg:20,xs:24},{default:b(()=>[v("div",te,[y(d,{ref_key:"queryFormRef",ref:ue,model:ce,inline:!0,"label-width":"auto"},{default:b(()=>[y(r,{label:"关键字",prop:"keywords"},{default:b(()=>[y(l,{modelValue:ce.keywords,"onUpdate:modelValue":a[1]||(a[1]=e=>ce.keywords=e),placeholder:"用户名/昵称/手机号",clearable:"",onKeyup:_(Ce,["enter"])},null,8,["modelValue"])]),_:1}),y(r,{label:"状态",prop:"status"},{default:b(()=>[y(n,{modelValue:ce.status,"onUpdate:modelValue":a[2]||(a[2]=e=>ce.status=e),placeholder:"全部",clearable:"",style:{width:"100px"}},{default:b(()=>[y(s,{label:"正常",value:1}),y(s,{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1}),y(r,{label:"创建时间"},{default:b(()=>[y(i,{modelValue:ce.createTime,"onUpdate:modelValue":a[3]||(a[3]=e=>ce.createTime=e),editable:!1,type:"daterange","range-separator":"~","start-placeholder":"开始时间","end-placeholder":"截止时间","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),y(r,{class:"search-buttons"},{default:b(()=>[y(u,{type:"primary",icon:"search",onClick:Ce},{default:b(()=>[...a[20]||(a[20]=[k("搜索",-1)])]),_:1}),y(u,{icon:"refresh",onClick:Ue},{default:b(()=>[...a[21]||(a[21]=[k("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),y(ne,{shadow:"hover",class:"data-table"},{default:b(()=>[v("div",le,[v("div",oe,[V((g(),j(u,{type:"success",icon:"plus",onClick:a[4]||(a[4]=e=>Ie())},{default:b(()=>[...a[22]||(a[22]=[k(" 新增 ",-1)])]),_:1})),[[Be,["sys:user:add"]]]),V((g(),j(u,{type:"danger",icon:"delete",disabled:!C(je),onClick:a[5]||(a[5]=e=>Ee())},{default:b(()=>[...a[23]||(a[23]=[k(" 删除 ",-1)])]),_:1},8,["disabled"])),[[Be,"sys:user:delete"]])]),v("div",re,[V((g(),j(u,{icon:"upload",onClick:Me},{default:b(()=>[...a[24]||(a[24]=[k(" 导入 ",-1)])]),_:1})),[[Be,"sys:user:import"]]),V((g(),j(u,{icon:"download",onClick:Re},{default:b(()=>[...a[25]||(a[25]=[k(" 导出 ",-1)])]),_:1})),[[Be,"sys:user:export"]])])]),V((g(),j(K,{data:me.value,border:"",stripe:"","highlight-current-row":"",class:"data-table__content","row-key":"id",onSelectionChange:C(xe)},{default:b(()=>[y(c,{type:"selection",width:"50",align:"center"}),y(c,{label:"用户名",prop:"username"}),y(c,{label:"昵称",width:"150",align:"center",prop:"nickname"}),y(c,{label:"性别",width:"100",align:"center"},{default:b(e=>[y(m,{modelValue:e.row.gender,"onUpdate:modelValue":a=>e.row.gender=a,code:"gender"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),y(c,{label:"部门",width:"120",align:"center",prop:"deptName"}),y(c,{label:"手机号码",align:"center",prop:"mobile",width:"120"}),y(c,{label:"邮箱",align:"center",prop:"email",width:"160"}),y(c,{label:"状态",align:"center",prop:"status",width:"80"},{default:b(e=>[y(E,{type:1==e.row.status?"success":"info"},{default:b(()=>[k(I(1==e.row.status?"正常":"禁用"),1)]),_:2},1032,["type"])]),_:1}),y(c,{label:"创建时间",align:"center",prop:"createTime",width:"150"}),y(c,{label:"操作",fixed:"right",width:"220"},{default:b(e=>[V((g(),j(u,{type:"primary",icon:"RefreshLeft",size:"small",link:"",onClick:a=>{return t=e.row,void Q.prompt(`请输入用户【${t.username}】的新密码`,"重置密码",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/.{6,}/,inputErrorMessage:"密码至少需要6位字符"}).then(({value:e})=>M.resetPassword(t.id,e)).then(()=>{o.success("密码重置成功")}).catch(e=>{"cancel"!==e&&o.error("密码重置失败")});var t}},{default:b(()=>[...a[26]||(a[26]=[k(" 重置密码 ",-1)])]),_:1},8,["onClick"])),[[Be,"sys:user:reset-password"]]),V((g(),j(u,{type:"primary",icon:"edit",link:"",size:"small",onClick:a=>Ie(e.row.id)},{default:b(()=>[...a[27]||(a[27]=[k(" 编辑 ",-1)])]),_:1},8,["onClick"])),[[Be,"sys:user:edit"]]),V((g(),j(u,{type:"danger",icon:"delete",link:"",size:"small",onClick:a=>Ee(e.row.id)},{default:b(()=>[...a[28]||(a[28]=[k(" 删除 ",-1)])]),_:1},8,["onClick"])),[[Be,"sys:user:delete"]])]),_:1})]),_:1},8,["data","onSelectionChange"])),[[Ne,fe.value]]),pe.value>0?(g(),j(W,{key:0,total:pe.value,"onUpdate:total":a[6]||(a[6]=e=>pe.value=e),page:ce.pageNum,"onUpdate:page":a[7]||(a[7]=e=>ce.pageNum=e),limit:ce.pageSize,"onUpdate:limit":a[8]||(a[8]=e=>ce.pageSize=e),onPagination:ke},null,8,["total","page","limit"])):x("",!0)]),_:1})]),_:1})]),_:1}),y($e,{modelValue:ge.visible,"onUpdate:modelValue":a[17]||(a[17]=e=>ge.visible=e),title:ge.title,"append-to-body":"",size:_e.value,onClose:Se},{footer:b(()=>[v("div",se,[y(u,{type:"primary",onClick:C(Ae)},{default:b(()=>[...a[29]||(a[29]=[k("确 定",-1)])]),_:1},8,["onClick"]),y(u,{onClick:Se},{default:b(()=>[...a[30]||(a[30]=[k("取 消",-1)])]),_:1})])]),default:b(()=>[y(d,{ref_key:"userFormRef",ref:de,model:ye,rules:we,"label-width":"80px"},{default:b(()=>[y(r,{label:"用户名",prop:"username"},{default:b(()=>[y(l,{modelValue:ye.username,"onUpdate:modelValue":a[9]||(a[9]=e=>ye.username=e),readonly:!!ye.id,placeholder:"请输入用户名"},null,8,["modelValue","readonly"])]),_:1}),y(r,{label:"用户昵称",prop:"nickname"},{default:b(()=>[y(l,{modelValue:ye.nickname,"onUpdate:modelValue":a[10]||(a[10]=e=>ye.nickname=e),placeholder:"请输入用户昵称"},null,8,["modelValue"])]),_:1}),y(r,{label:"所属部门",prop:"deptId"},{default:b(()=>[y(Ve,{modelValue:ye.deptId,"onUpdate:modelValue":a[11]||(a[11]=e=>ye.deptId=e),placeholder:"请选择所属部门",data:be.value,filterable:"","check-strictly":"","render-after-expand":!1},null,8,["modelValue","data"])]),_:1}),y(r,{label:"性别",prop:"gender"},{default:b(()=>[y(Te,{modelValue:ye.gender,"onUpdate:modelValue":a[12]||(a[12]=e=>ye.gender=e),code:"gender"},null,8,["modelValue"])]),_:1}),y(r,{label:"角色",prop:"roleIds"},{default:b(()=>[y(n,{modelValue:ye.roleIds,"onUpdate:modelValue":a[13]||(a[13]=e=>ye.roleIds=e),multiple:"",placeholder:"请选择"},{default:b(()=>[(g(!0),f(S,null,A(ve.value,e=>(g(),j(s,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),y(r,{label:"手机号码",prop:"mobile"},{default:b(()=>[y(l,{modelValue:ye.mobile,"onUpdate:modelValue":a[14]||(a[14]=e=>ye.mobile=e),placeholder:"请输入手机号码",maxlength:"11"},null,8,["modelValue"])]),_:1}),y(r,{label:"邮箱",prop:"email"},{default:b(()=>[y(l,{modelValue:ye.email,"onUpdate:modelValue":a[15]||(a[15]=e=>ye.email=e),placeholder:"请输入邮箱",maxlength:"50"},null,8,["modelValue"])]),_:1}),y(r,{label:"状态",prop:"status"},{default:b(()=>[y(ze,{modelValue:ye.status,"onUpdate:modelValue":a[16]||(a[16]=e=>ye.status=e),"inline-prompt":"","active-text":"正常","inactive-text":"禁用","active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title","size"]),y(ee,{modelValue:he.value,"onUpdate:modelValue":a[18]||(a[18]=e=>he.value=e),onImportSuccess:a[19]||(a[19]=e=>Ce())},null,8,["modelValue"])])}}});export{ne as default};
